<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug - My Collection</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100vh;
      padding: 1rem;
    }
    .debug-card {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-success {
      background-color: #10b981;
      color: white;
    }
    .status-error {
      background-color: #ef4444;
      color: white;
    }
    .status-warning {
      background-color: #f59e0b;
      color: white;
    }
    .code-block {
      background: rgba(0, 0, 0, 0.3);
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-family: monospace;
      font-size: 0.875rem;
      word-break: break-all;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-white mb-6">üîç Debug Information</h1>
    
    <!-- Service Worker Status -->
    <div class="debug-card">
      <h2 class="text-xl font-semibold text-white mb-3">Service Worker</h2>
      <div id="swStatus" class="mb-2">
        <span class="status-badge status-warning">Checking...</span>
      </div>
      <div id="swDetails" class="text-gray-300 text-sm"></div>
    </div>

    <!-- FCM Token -->
    <div class="debug-card">
      <h2 class="text-xl font-semibold text-white mb-3">FCM Token</h2>
      <div id="fcmStatus" class="mb-2">
        <span class="status-badge status-warning">Loading...</span>
      </div>
      <div id="fcmToken" class="code-block text-gray-300 mt-2"></div>
      <button id="refreshFCM" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
        Refresh FCM Token
      </button>
    </div>

    <!-- Notification Permissions -->
    <div class="debug-card">
      <h2 class="text-xl font-semibold text-white mb-3">Notification Permissions</h2>
      <div id="permStatus" class="mb-2"></div>
      <button id="requestPerm" class="mt-3 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
        Request Permission
      </button>
    </div>

    <!-- Badge API -->
    <div class="debug-card">
      <h2 class="text-xl font-semibold text-white mb-3">Badge API</h2>
      <div id="badgeStatus" class="mb-2"></div>
      <div class="mt-3 flex gap-2">
        <button id="setBadge" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          Set Badge (1)
        </button>
        <button id="clearBadge" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
          Clear Badge
        </button>
      </div>
    </div>

    <!-- Notifications Count -->
    <div class="debug-card">
      <h2 class="text-xl font-semibold text-white mb-3">Notifications</h2>
      <div id="notifCount" class="text-gray-300"></div>
    </div>

    <!-- Device Info -->
    <div class="debug-card">
      <h2 class="text-xl font-semibold text-white mb-3">Device Info</h2>
      <div id="deviceInfo" class="text-gray-300 text-sm space-y-1"></div>
    </div>
  </div>

  <script type="module">
    import { getFCMToken, initFCM } from "./js/notifications/fcm.js";
    import { setBadge, clearBadge, isBadgeAPISupported } from "./js/notifications/badge.js";
    import { getNotifications } from "./js/modules/notifications.js";

    // Service Worker Status
    async function checkServiceWorker() {
      const swStatus = document.getElementById('swStatus');
      const swDetails = document.getElementById('swDetails');
      
      if ('serviceWorker' in navigator) {
        try {
          const registrations = await navigator.serviceWorker.getRegistrations();
          if (registrations.length > 0) {
            swStatus.innerHTML = '<span class="status-badge status-success">Registered</span>';
            let details = '<div class="mt-2 space-y-1">';
            registrations.forEach((reg, index) => {
              details += `<div>SW ${index + 1}: ${reg.scope}</div>`;
              details += `<div class="text-xs text-gray-400">State: ${reg.active?.state || 'unknown'}</div>`;
            });
            details += '</div>';
            swDetails.innerHTML = details;
          } else {
            swStatus.innerHTML = '<span class="status-badge status-error">Not Registered</span>';
            swDetails.innerHTML = '<div class="text-gray-400 text-sm mt-2">No service workers found. Try refreshing the page.</div>';
          }
        } catch (error) {
          swStatus.innerHTML = '<span class="status-badge status-error">Error</span>';
          swDetails.innerHTML = `<div class="text-red-400 text-sm mt-2">${error.message}</div>`;
        }
      } else {
        swStatus.innerHTML = '<span class="status-badge status-error">Not Supported</span>';
        swDetails.innerHTML = '<div class="text-gray-400 text-sm mt-2">Service Workers are not supported in this browser.</div>';
      }
    }

    // FCM Token
    async function updateFCMToken() {
      const fcmStatus = document.getElementById('fcmStatus');
      const fcmToken = document.getElementById('fcmToken');
      
      try {
        const token = getFCMToken();
        if (token) {
          fcmStatus.innerHTML = '<span class="status-badge status-success">Token Available</span>';
          fcmToken.textContent = token;
        } else {
          fcmStatus.innerHTML = '<span class="status-badge status-warning">No Token</span>';
          fcmToken.textContent = 'FCM token not available. Try initializing FCM.';
        }
      } catch (error) {
        fcmStatus.innerHTML = '<span class="status-badge status-error">Error</span>';
        fcmToken.textContent = `Error: ${error.message}`;
      }
    }

    // Notification Permissions
    function updatePermissions() {
      const permStatus = document.getElementById('permStatus');
      
      if ('Notification' in window) {
        const permission = Notification.permission;
        if (permission === 'granted') {
          permStatus.innerHTML = '<span class="status-badge status-success">Granted</span>';
        } else if (permission === 'denied') {
          permStatus.innerHTML = '<span class="status-badge status-error">Denied</span>';
        } else {
          permStatus.innerHTML = '<span class="status-badge status-warning">Default (Not Set)</span>';
        }
      } else {
        permStatus.innerHTML = '<span class="status-badge status-error">Not Supported</span>';
      }
    }

    // Badge API
    function updateBadgeStatus() {
      const badgeStatus = document.getElementById('badgeStatus');
      
      if (isBadgeAPISupported()) {
        badgeStatus.innerHTML = '<span class="status-badge status-success">Supported</span>';
      } else {
        badgeStatus.innerHTML = '<span class="status-badge status-error">Not Supported</span>';
      }
    }

    // Notifications Count
    async function updateNotificationsCount() {
      const notifCount = document.getElementById('notifCount');
      
      try {
        const notifications = await getNotifications();
        const unreadCount = notifications.filter(n => !n.read).length;
        notifCount.innerHTML = `
          <div>Total: ${notifications.length}</div>
          <div>Unread: <span class="font-bold">${unreadCount}</span></div>
        `;
      } catch (error) {
        notifCount.innerHTML = `<div class="text-red-400">Error: ${error.message}</div>`;
      }
    }

    // Device Info
    function updateDeviceInfo() {
      const deviceInfo = document.getElementById('deviceInfo');
      
      const info = {
        'User Agent': navigator.userAgent.substring(0, 100) + '...',
        'Platform': navigator.platform,
        'Standalone': window.navigator.standalone || false,
        'Display Mode': window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'browser',
        'PWA Installed': window.matchMedia('(display-mode: standalone)').matches,
      };
      
      let html = '';
      for (const [key, value] of Object.entries(info)) {
        html += `<div><span class="font-semibold">${key}:</span> ${value}</div>`;
      }
      deviceInfo.innerHTML = html;
    }

    // Event Listeners
    document.getElementById('refreshFCM').addEventListener('click', async () => {
      await initFCM();
      setTimeout(updateFCMToken, 1000);
    });

    document.getElementById('requestPerm').addEventListener('click', async () => {
      if ('Notification' in window) {
        const permission = await Notification.requestPermission();
        updatePermissions();
        if (permission === 'granted') {
          await initFCM();
          setTimeout(updateFCMToken, 1000);
        }
      }
    });

    document.getElementById('setBadge').addEventListener('click', async () => {
      await setBadge(1);
      alert('Badge set to 1');
    });

    document.getElementById('clearBadge').addEventListener('click', async () => {
      await clearBadge();
      alert('Badge cleared');
    });

    // Initialize
    checkServiceWorker();
    updateFCMToken();
    updatePermissions();
    updateBadgeStatus();
    updateNotificationsCount();
    updateDeviceInfo();

    // Initialize FCM if not already done
    initFCM().then(() => {
      setTimeout(updateFCMToken, 1000);
    });

    // Refresh every 5 seconds
    setInterval(() => {
      updateFCMToken();
      updateNotificationsCount();
    }, 5000);
  </script>
</body>
</html>


